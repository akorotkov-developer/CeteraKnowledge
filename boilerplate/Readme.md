# Докер и локальная разработка

Этот репозиторий должен подключаться как подмодуль к основному репозиторию проекту.

Подробная пошаговая инструкция о том, как запустить сайт локально с помощью докера в нашей [базе знаний](https://kb.cetera.ru/docs/development/docker/start).

Нижеследующий текст бесполезен, если вы не ознакомитесь с этой инструкцией.

## Документация по makefile'ам проекта

### cetera.mk 

Makefile, который включается во все проекты Cetera. Используется для автоматизации рутинных задач, связанных с локальной разработкой, как то:
* генерация .env файлов
* докеризация проекта
* скачивание проекта с сервера на локальный ПК

Если вы хотите что-то поменять в Makefile проекта, прочитайте сначала [документацию по make](https://www.gnu.org/software/make/manual/html_node/index.html).

Для успешного запуска данного Makefile необходим GNU Make версии не ниже 4.0

В файле определены следующие цели

#### clean
Удаляет созданные автоматом файлы и папки - .env, .env.project, tmp. Следует использовать только при тестировании докеразации проекта.

#### .env.project
Создает в проекте файл .env.project с мета-информацией о настройках боевого сервера. Впоследствие этот файл будет добавлен в репозиторий.

#### env
На основе файла .env.project создает файл .env, который используется внутри файла docker-compose.yml и при деплое.

#### tmp/.gitkeep
Создает папку tmp с пустым файлом .gitkeep. Впоследствие в эту папку будут складываться временные файлы, создаваемые в процессе локальной разработки.
Новые проекты создаются уже с этой папкой.

#### service_files
Цель, которая создает вышеописанные файлы и складывает их в git.

#### update_boilerplate
Обновляет подмодуль boilerplate.

#### docker_down
Выполняет docker-compose down.

#### sync_db
Скачивает с сервера копию БД (обычно из вчерашней резервной копии) и удаляет содержимое папки БД.
Таким образом, при следующем запуске контейнера с БД база будет заново инициализрована из скачанного дампа.

#### sync_files
Скачивает с сервера копию файлов  (обычно из вчерашней резервной копии) и разворачивает поверх них текущее состояние репозитория.

#### sync_master
Скачивает с боевого сервера копию БД и файлов.

#### sync_beta
Скачивает с бета сервера копию БД и файлов.

#### init
Шорткат для создания .env файла, прочих служебных файлов проекта и sync_db и sync_files.

#### .docker
Цель, которая запускается каждый раз при make docker. В настоящий момент служит для обновления подмодуля перез запуском docker-compose.

#### docker
Запускает docker-compose.

#### php_bash
Запускает php-консоль. Рабочая директория ссылается на корень вашего проекта.
Внутри доступны
* [Composer](https://getcomposer.org/) через команду `composer`
* [PHP CodeSniffer](https://github.com/squizlabs/PHP_CodeSniffer) через команды `phpcs` и `phpcbf`

#### mysql_bash
Запускает mysql-консоль с базой текущего проекта.

#### pull_images
Скачивает последние версии всех необходимых образов.

#### composer_install
[Скачивает](https://getcomposer.org/doc/01-basic-usage.md#installing-dependencies) внешние зависимости в соответствии с composer.lock.

#### composer_update
[Обновляет](https://getcomposer.org/doc/01-basic-usage.md#updating-dependencies-to-their-latest-versions) внешние зависимости в соответствии с composer.json.

#### phpcs
Проверка исходного кода на соответствие PSR 1 и 2 с помощью библиотеки [PHP CodeSniffer](https://github.com/squizlabs/PHP_CodeSniffer).

#### phpcbf
Автоматическое частичное исправление исходного кода на соответствие PSR 1 и 2 с помощью библиотеки [PHP CodeSniffer](https://github.com/squizlabs/PHP_CodeSniffer).

